version: "3.8"
services:
  # ===========================
  # PostgreSQL DB cho Airflow
  # ===========================
  postgres:
    image: postgres:15
    networks:
      - airflow_net
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - 5432:5432

  # ===========================
  # Airflow Init (DB + user)
  # ===========================
  airflow-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    image: eltwx/airflow-init:latest
    networks:
      - airflow_net
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__FERNET_KEY: "kX0n8hX1o9Q7Zx9dKfT_jl5iVxHbO0K0vW2Xzq9pQ1I="
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "mysecret123"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    volumes:
      - ./dags:/opt/airflow/dags
    entrypoint:
      [
        "bash",
        "-c",
        "airflow db init && airflow users create --username admin --password admin --firstname Admin --lastname Admin --role Admin --email admin@example.com || true",
      ]
    depends_on:
      - postgres

  # ===========================
  # Airflow Webserver
  # ===========================
  airflow-webserver:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    image: eltwx/airflow-webserver:latest
    networks:
      - airflow_net
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__FERNET_KEY: "kX0n8hX1o9Q7Zx9dKfT_jl5iVxHbO0K0vW2Xzq9pQ1I="
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "mysecret123"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    ports:
      - 8080:8080
    volumes:
      - ./dags:/opt/airflow/dags
      - log_air_data:/opt/airflow/logs # üìù Th√™m mount log
      - /tmp:/tmp
    depends_on:
      - airflow-init
    command: webserver

  # ===========================
  # Airflow Scheduler
  # ===========================
  airflow-scheduler:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    image: eltwx/airflow-scheduler:latest
    command: airflow scheduler
    networks:
      - airflow_net
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__FERNET_KEY: "kX0n8hX1o9Q7Zx9dKfT_jl5iVxHbO0K0vW2Xzq9pQ1I="
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: "mysecret123"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - log_air_data:/opt/airflow/logs # üìù Th√™m mount log
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
    depends_on:
      - airflow-init

  # ===========================
  # ETL Runner
  # ===========================
  etl-runner:
    build:
      context: .
      dockerfile: docker/Dockerfile.etl
    image: eltwx/etl-runner:latest
    working_dir: /opt/etl
    networks:
      - airflow_net
    volumes:
      - ./sql:/opt/etl/sql # SQL scripts
      - ./scripts:/opt/etl/scripts # Python ETL scripts
      - ./utils:/opt/etl/utils # utils
      - log_elt_data:/opt/etl/log # log persistent
      - duckdb_data:/opt/etl/db # FIXED ‚Äî DuckDB DB persistent (ƒë√∫ng ch·ªó)
      - delta_data:/opt/etl/data # Delta persistent
    command: tail -f /dev/null

# ===========================
# Named Volumes
# ===========================
volumes:
  duckdb_data:
  delta_data:
  log_air_data:
  log_elt_data:
  postgres_data:

networks:
  airflow_net:
    driver: bridge
